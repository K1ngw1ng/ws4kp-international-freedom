(()=>{"use strict";const e=(e,o)=>t(e,"json",o),t=async(e,t,n={})=>{const r={method:"GET",mode:"cors",type:"GET",retryCount:0,...n};r.originalRetries=r.retryCount;let a=e;!0===r.cors&&(a=(e=>{let t=e;return t=t.replace("https://api.weather.gov/",`${window.location.protocol}//${window.location.host}/`),t=t.replace("https://www.cpc.ncep.noaa.gov/",`${window.location.protocol}//${window.location.host}/`),t})(e));const s=new URL(a,`${window.location.origin}/`);r.data&&Object.keys(r.data).forEach((e=>{const t=r.data[e];s.searchParams.append(e,t)}));const c=await o(s,r);if(!c.ok)throw new Error(`Fetch error ${c.status} ${c.statusText} while fetching ${c.url}`);switch(t){case"json":return c.json();case"text":return c.text();case"blob":return c.blob();default:return c}},o=(e,t)=>new Promise(((a,s)=>{fetch(e,t).then((s=>{if(t.retryCount>0){if(s.status>=500&&s.status<=599&&t.retryCount>0){"function"==typeof t.stillWaiting&&t.retryCount===t.originalRetries&&t.stillWaiting();const s={...t,retryCount:t.retryCount-1};return a(n(r(t.originalRetries-s.retryCount),o,e,s))}return a(s)}return a(s)})).catch((e=>s(e)))})),n=(e,t,...o)=>new Promise((n=>{setTimeout((()=>{n(t(...o))}),e)})),r=e=>{switch(e){case 1:return 1e3;case 2:return 2e3;case 3:return 5e3;case 4:return 1e4;default:return 3e4}};let a=!1;const s=(e=!1)=>(s.controller||(s.controller=new NoSleep),a!==e&&(a=e,e?s.controller.enable():s.controller.disable())),c=s,l={loading:Symbol("loading"),loaded:Symbol("loaded"),failed:Symbol("failed"),noData:Symbol("noData"),disabled:Symbol("disabled"),retrying:Symbol("retrying")},i=l;document.addEventListener("DOMContentLoaded",(()=>d()));const u={kiosk:"settings-kiosk-checkbox"},d=()=>{const e=document.querySelector("#share-link");e.addEventListener("click",m),navigator?.clipboard||(e.textContent="Get Permalink")},m=async e=>{e.preventDefault();const t=document.querySelectorAll("input[type=checkbox]"),o={};[...t].forEach((e=>{e?.id&&(o[e.id]=e?.checked??!1)}));[...document.querySelectorAll("select")].forEach((e=>{e?.id&&(o[e.id]=e?.value??0)})),o.latLonQuery=localStorage.getItem("latLonQuery"),o.latLon=localStorage.getItem("latLon");const n=new URLSearchParams(o).toString(),r=new URL(`?${n}`,document.location.href);navigator?.clipboard?h(r):g(r)},h=async e=>{try{await navigator.clipboard.writeText(e.toString());const t=document.querySelector("#share-link-copied");t.style.display="inline",setTimeout((()=>{t.style.display="none"}),5e3)}catch(e){console.error(e)}},g=e=>{const t=document.querySelector("#share-link-instructions"),o=t.querySelector("#share-link-url");o.value=e,t.style.display="inline",o.focus(),o.select()},y=()=>{if(y.params)return y.params;const e=[...new URLSearchParams(window.location.search)];return e.forEach((t=>{const o=u[t[0]];o&&e.push([o,t[1]])})),y.params=Object.fromEntries(e),y.params},p="Settings";const v=class{constructor(e,t,o,n,r,a,s){this.shortName=e,this.name=t,this.defaultValue=n,this.myValue=n,this.type=o??"checkbox",this.sticky=a,this.values=s,this.changeAction=r??(()=>{});const c=y()?.[`settings-${e}-${o}`];let l;"checkbox"===o&&void 0!==c&&(l="true"===c),"select"===o&&void 0!==c&&(l=parseFloat(c));const i=l??this.getFromLocalStorage();if(a&&null!==i&&(this.myValue=i),"select"===o)this.selectChange({target:{value:this.myValue}});else this.checkboxChange({target:{checked:this.myValue}})}generateSelect(){const e=document.createElement("label");e.for=`settings-${this.shortName}-select`,e.id=`settings-${this.shortName}-label`;const t=document.createElement("span");t.innerHTML=`${this.name} `,e.append(t);const o=document.createElement("select");return o.id=`settings-${this.shortName}-select`,o.name=`settings-${this.shortName}-select`,o.addEventListener("change",(e=>this.selectChange(e))),this.values.forEach((([e,t])=>{const n=document.createElement("option");n.value=e.toFixed(2),n.innerHTML=t,o.append(n)})),e.append(o),this.element=e,this.selectHighlight(this.myValue),e}generateCheckbox(){const e=document.createElement("label");e.for=`settings-${this.shortName}-checkbox`,e.id=`settings-${this.shortName}-label`;const t=document.createElement("input");t.type="checkbox",t.value=!0,t.id=`settings-${this.shortName}-checkbox`,t.name=`settings-${this.shortName}-checkbox`,t.checked=this.myValue,t.addEventListener("change",(e=>this.checkboxChange(e)));const o=document.createElement("span");return o.innerHTML=this.name,e.append(t,o),this.element=e,e}checkboxChange(e){this.myValue=e.target.checked,this.storeToLocalStorage(this.myValue),this.changeAction(this.myValue)}selectChange(e){this.myValue=parseFloat(e.target.value),this.storeToLocalStorage(this.myValue),this.changeAction(this.myValue)}storeToLocalStorage(e){if(!this.sticky)return;const t=localStorage?.getItem(p)??"{}",o=JSON.parse(t);o[this.shortName]=e,localStorage?.setItem(p,JSON.stringify(o))}getFromLocalStorage(){const e=localStorage?.getItem(p);try{if(e){const t=JSON.parse(e)?.[this.shortName];if(void 0!==t)switch(this.type){case"boolean":case"select":return t;default:return null}}}catch{return null}return null}get value(){return this.myValue}set value(e){if(this.myValue=e,"select"===this.type)this.selectHighlight(e);else this.element.checked=e;this.storeToLocalStorage(this.myValue),this.changeAction(this.myValue)}selectHighlight(e){this.element.querySelectorAll("option").forEach((t=>{t.selected=e.toFixed(2)===t.value}))}generate(){return"select"===this.type?this.generateSelect():this.generateCheckbox()}};document.addEventListener("DOMContentLoaded",(()=>{f()}));const S={speed:{value:1}},f=()=>{S.wide=new v("wide","Widescreen","checkbox",!1,w,!0),S.kiosk=new v("kiosk","Kiosk","boolean",!1,L,!1),S.speed=new v("speed","Speed","select",1,null,!0,[[.5,"Very Fast"],[.75,"Fast"],[1,"Normal"],[1.25,"Slow"],[1.5,"Very Slow"]]);const e=Object.values(S).map((e=>e.generate())),t=document.querySelector("#settings");t.innerHTML="",t.append(...e)},w=e=>{const t=document.querySelector("#divTwc");e?t.classList.add("wide"):t.classList.remove("wide")},L=e=>{const t=document.querySelector("body");e?(t.classList.add("kiosk"),window.dispatchEvent(new Event("resize"))):t.classList.remove("kiosk")},k=S;document.addEventListener("DOMContentLoaded",(()=>{I()}));const b=[];let E,_=!1;const q={},x=6e5,F="#chkAutoRefresh";let T=null,C=0;const I=async()=>{window.addEventListener("resize",B),B();const e=localStorage.getItem("autoRefresh");document.querySelector(F).checked=!e||"true"===e,document.querySelector(F).addEventListener("change",U),G()},N=async(t,o)=>{const n=await(async(t,o)=>{try{return await e(`https://api.open-meteo.com/v1/forecast?latitude=${t}&longitude=${o}&daily=temperature_2m_max,temperature_2m_min&hourly=temperature_2m,relative_humidity_2m,dew_point_2m,apparent_temperature,precipitation_probability,precipitation,rain,showers,snowfall,snow_depth,weather_code,pressure_msl,surface_pressure,cloud_cover,visibility,evapotranspiration,et0_fao_evapotranspiration,vapour_pressure_deficit,uv_index,uv_index_clear_sky,is_day,sunshine_duration,wet_bulb_temperature_2m,wind_speed_10m,wind_direction_10m,wind_gusts_10m&models=best_match`)}catch(e){return console.log(`Unable to get point ${t}, ${o}`),console.error(e),!1}})(t.lat,t.lon),r=(e=>{const{hourly:t,daily:o}=e,n=Object.keys(t).filter((e=>"time"!==e)),r={};t.time.forEach(((e,o)=>{const a=e.split("T")[0];r[a]||(r[a]={hours:[],weather_code_counts:{}},n.forEach((e=>{r[a][e]={sum:0,count:0}})));const s={time:e};if(n.forEach((e=>{s[e]=t[e][o],r[a][e].sum+=t[e][o],r[a][e].count+=1})),t.weather_code){const e=t.weather_code[o];r[a].weather_code_counts[e]=(r[a].weather_code_counts[e]||0)+1}r[a].hours.push(s)}));const a={};return Object.entries(r).forEach((([e,t])=>{a[e]={hours:t.hours},n.forEach((o=>{a[e][o]=t[o].sum/t[o].count}));const o=Object.entries(t.weather_code_counts);o.length>0&&([a[e].weather_code]=o.reduce(((e,t)=>t[1]>e[1]?t:e)))})),o.time.forEach(((e,t)=>{r[e]||(r[e]={hours:[]}),a[e].temperature_2m_max=o.temperature_2m_max[t],a[e].temperature_2m_min=o.temperature_2m_min[t]})),a})(n);"function"==typeof o&&o(n);const a=localStorage.getItem("latLonQuery"),s=await(async t=>{try{return await e(`https://geocoding-api.open-meteo.com/v1/search?name=${t}&count=10&language=en&format=json`)}catch(e){return console.log(`Unable to get locality with value ${t}`),console.error(e),!1}})(a.split(",")[0]);let c=s.results[0].name,l=s.results[0].country,i=s.results[0].admin1,u=s.results[0].timezone;q.latitude=t.lat,q.longitude=t.lon,q.city=c,q.state=i,q.country=l,q.timeZone=u,q.forecast=r,q.stationId="stationId-dont-matter-anymore",q.zoneId="zoneId-dont-matter",q.radarId="radarId-dont-matter",q.weatherOffice="weatherOffice-dont-matter",j(q),P(),document.querySelector("#loading").style.display="none",E&&(await E.drawCanvas(),E.showCanvas()),b.forEach((e=>e.getData(q)))},P=()=>{b.forEach((e=>e.hideCanvas()))},R=()=>_,M={response:{previous:Symbol("previous"),inProgress:Symbol("inProgress"),next:Symbol("next")},command:{firstFrame:Symbol("firstFrame"),previousFrame:Symbol("previousFrame"),nextFrame:Symbol("nextFrame"),lastFrame:Symbol("lastFrame")}},H=e=>{const t=D();if(E.hideCanvas(),!t){let e,t=0;do{b[t].status===i.loaded&&b[t].timing.totalScreens>0&&(e=b[t]),t+=1}while(!e&&t<b.length);if(!e)return;return e.navNext(M.command.firstFrame),void e.showCanvas()}e===M.command.nextFrame&&D().navNext(),e===M.command.previousFrame&&D().navPrev()},O=()=>b.findIndex((e=>e.active)),D=()=>b[O()],V=e=>{_=e;const t=document.querySelector("#NavigatePlay");localStorage.setItem("play",_),_?(c(!0),t.title="Pause",t.src="images/nav/ic_pause_white_24dp_2x.png"):(c(!1),t.title="Play",t.src="images/nav/ic_play_arrow_white_24dp_2x.png"),E&&_&&!D()&&H(M.command.firstFrame)},A=e=>{switch(e){case"play":V(!0);break;case"playToggle":V(!_);break;case"stop":V(!1);break;case"next":V(!1),H(M.command.nextFrame);break;case"previous":V(!1),H(M.command.previousFrame);break;case"menu":V(!1),E.showCanvas(),P();break;default:console.error(`Unknown navButton ${e}`)}},B=()=>{const e=k.wide.value?854:640,t=document.querySelector("#divTwcBottom").getBoundingClientRect().width/e,o=window.innerHeight/480,n=Math.min(t,o);n<1||document.fullscreenElement||k.kiosk?document.querySelector("#container").style.transform=`scale(${n})`:document.querySelector("#container").style.transform="unset"},G=()=>{const e=document.querySelector("#enabledDisplays");if(!e)return;const t=b.map((e=>e.generateCheckbox(e.defaultEnabled))).filter((e=>e));e.innerHTML="",e.append(...t)},j=e=>{document.querySelector("#spanCity").innerHTML=`${e.city}, `,document.querySelector("#spanState").innerHTML=e.state,document.querySelector("#spanStationId").innerHTML=e.stationId,document.querySelector("#spanRadarId").innerHTML=e.radarId,document.querySelector("#spanZoneId").innerHTML=e.zoneId},U=e=>{const{checked:t}=e.target;t?Q():W(),localStorage.setItem("autoRefresh",t)},z=e=>{e?(document.querySelector("#spanLastRefresh").innerHTML=e.toLocaleString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric",second:"numeric",timeZoneName:"short"}),document.querySelector(F).checked&&Q()):document.querySelector("#spanLastRefresh").innerHTML="(none)"},Q=()=>{if(T)return;C=0;const e=()=>{C+=500;let e=x-C;e<0&&(e=0);const t=new Date(e);document.querySelector("#spanRefreshCountDown").innerHTML=`${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`,C>=x&&!R()&&J()};T=window.setInterval(e,500),e()},W=()=>{T&&(window.clearInterval(T),document.querySelector("#spanRefreshCountDown").innerHTML="--:--",T=null)},J=()=>{J.callback&&J.callback()},Z=(e,t)=>Math.trunc(e*10**t)/10**t;document.addEventListener("DOMContentLoaded",(()=>{te()}));const K=["Land Features","Bay","Channel","Cove","Dam","Delta","Gulf","Lagoon","Lake","Ocean","Reef","Reservoir","Sea","Sound","Strait","Waterfall","Wharf","Amusement Park","Historical Monument","Landmark","Tourist Attraction","Zoo","College","Beach","Campground","Golf Course","Harbor","Nature Reserve","Other Parks and Outdoors","Park","Racetrack","Scenic Overlook","Ski Resort","Sports Center","Sports Field","Wildlife Reserve","Airport","Ferry","Marina","Pier","Port","Resort","Postal","Populated Place"].join(","),X="#txtAddress",Y="#ToggleFullScreen",ee="#btnGetGps",te=()=>{var e;document.querySelector(X).addEventListener("focus",(e=>{e.target.select()})),e=ie,J.callback=e,document.querySelector("#NavigateMenu").addEventListener("click",le),document.querySelector("#NavigateRefresh").addEventListener("click",de),document.querySelector("#NavigateNext").addEventListener("click",me),document.querySelector("#NavigatePrevious").addEventListener("click",he),document.querySelector("#NavigatePlay").addEventListener("click",ve),document.querySelector(Y).addEventListener("click",re);const t=document.querySelector(ee);t.addEventListener("click",fe),navigator.geolocation||(t.style.display="none"),document.querySelector("#divTwc").addEventListener("mousemove",(()=>{document.fullscreenElement&&ye()})),window.addEventListener("resize",we),we.wasFull=!1,document.querySelector(X).addEventListener("keydown",(e=>{"Enter"===e.code&&o()})),document.querySelector("#btnGetLatLng").addEventListener("click",(()=>o())),document.addEventListener("keydown",pe),document.addEventListener("touchmove",(e=>{document.fullscreenElement&&e.preventDefault()})),$(X).devbridgeAutocomplete({serviceUrl:"https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/suggest",deferRequestBy:300,paramName:"text",params:{f:"json",category:K,maxSuggestions:10},dataType:"json",transformResult:e=>({suggestions:e.suggestions.map((e=>({value:e.text,data:e.magicKey})))}),minChars:3,showNoSuggestionNotice:!0,noSuggestionNotice:"No results found. Please try a different search string.",onSelect(e){oe(e,this)},width:490});const o=()=>{const e=$(X).devbridgeAutocomplete();return e.suggestions[0]&&$(e.suggestionsContainer.children[0]).trigger("click"),!1},n=y(),r=n.latLonQuery&&n.latLon,a=n.latLonQuery??localStorage.getItem("latLonQuery"),s=n.latLon??localStorage.getItem("latLon"),c=localStorage.getItem("latLonFromGPS")&&!r;if(a&&s&&!c){document.querySelector(X).value=a,ie(JSON.parse(s))}c&&fe(),k.kiosk.value="true"===n["settings-kiosk-checkbox"];const l=n["settings-kiosk-checkbox"]??localStorage.getItem("play");null!==l&&"true"!==l||Se("navButton","play"),document.querySelector("#btnClearQuery").addEventListener("click",(()=>{document.querySelector("#spanCity").innerHTML="",document.querySelector("#spanState").innerHTML="",document.querySelector("#spanStationId").innerHTML="",document.querySelector("#spanRadarId").innerHTML="",document.querySelector("#spanZoneId").innerHTML="",document.querySelector("#chkAutoRefresh").checked=!0,localStorage.removeItem("autoRefresh"),localStorage.removeItem("play"),Se("navButton","play"),localStorage.removeItem("latLonQuery"),localStorage.removeItem("latLon"),localStorage.removeItem("latLonFromGPS"),document.querySelector(ee).classList.remove("active")})),document.querySelector("#container").addEventListener("swiped-left",(()=>ue("left"))),document.querySelector("#container").addEventListener("swiped-right",(()=>ue("right")))},oe=async(t,o)=>{if(o.previousSuggestionValue===t.value)return;const n=(await e("https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/find",{data:{text:t.value,magicKey:t.data,f:"json"}})).locations[0];n?(localStorage.removeItem("latLonFromGPS"),document.querySelector(ee).classList.remove("active"),ne(n.feature.geometry)):console.error("An unexpected error occurred. Please try a different search string.")},ne=(e,t)=>{const o={lat:Z(e.y,4),lon:Z(e.x,4)};localStorage.setItem("latLonQuery",document.querySelector(X).value),localStorage.setItem("latLon",JSON.stringify(o)),ie(o,t)},re=()=>(document.fullscreenElement?se():ae(),R()?c(!0):c(!1),ye(),!1),ae=()=>{const e=document.querySelector("#divTwc"),t=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen||e.msRequestFullscreen;t?t.call(e,{navigationUI:"hide"}):window.scrollTo(0,0),B(),ye();const o=document.querySelector(Y);o.src="images/nav/ic_fullscreen_exit_white_24dp_2x.png",o.title="Exit fullscreen"},se=()=>{document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),B(),ce()},ce=()=>{const e=document.querySelector(Y);e.src="images/nav/ic_fullscreen_white_24dp_2x.png",e.title="Enter fullscreen",document.querySelector("#divTwc").classList.remove("no-cursor");const t=document.querySelector("#divTwcBottom");t.classList.remove("hidden"),t.classList.add("visible")},le=()=>(Se("navButton","menu"),!1),ie=(e,t)=>{e&&(ie.latLon=e);const{latLon:o}=ie;o&&(document.querySelector(X).blur(),W(),((e,t)=>{N(e,t),z(null)})(o,t))},ue=e=>{if("left"===e)me();else he()},de=()=>(b.forEach((e=>{e.status=i.loading})),ie(),!1),me=()=>(Se("navButton","next"),!1),he=()=>(Se("navButton","previous"),!1);let ge=null;const ye=()=>{document.activeElement.blur();const e=document.querySelector("#divTwcBottom");e.classList.remove("hidden"),e.classList.add("visible"),document.querySelector("#divTwc").classList.remove("no-cursor"),ge&&(clearTimeout(ge),ge=null),ge=setTimeout((()=>{document.fullscreenElement&&(e.classList.remove("visible"),e.classList.add("hidden"),document.querySelector("#divTwc").classList.add("no-cursor"))}),2e3)},pe=e=>{const{key:t}=e;if(document.fullscreenElement||document.activeElement===document.body)switch(t){case" ":return e.preventDefault(),ve(),!1;case"ArrowRight":case"PageDown":return e.preventDefault(),me(),!1;case"ArrowLeft":case"PageUp":return e.preventDefault(),he(),!1;case"ArrowUp":return e.preventDefault(),le(),!1;case"0":return de(),!1;case"F":case"f":return re(),!1}return!1},ve=()=>(Se("navButton","playToggle"),!1),Se=(e,t={})=>{var o;(o={type:e,message:t}).type&&("navButton"===o.type?A(o.message):console.error(`Unknown event ${o.type}`))},fe=async()=>{if(!navigator.geolocation)return;const e=document.querySelector(ee);if(e.classList.contains("active"))return e.classList.remove("active"),void localStorage.removeItem("latLonFromGPS");e.classList.add("active");const t=await(async()=>new Promise((e=>{navigator.geolocation.getCurrentPosition(e)})))(),{latitude:o,longitude:n}=t.coords,r=document.querySelector(X);r.value=`${Z(o,4)}, ${Z(n,4)}`,ne({y:o,x:n},(e=>{const t=e.properties.relativeLocation.properties,a=`${t.city}, ${t.state}`;localStorage.setItem("latLon",JSON.stringify({lat:o,lon:n})),localStorage.setItem("latLonQuery",a),localStorage.setItem("latLonFromGPS",!0),r.value=`${t.city}, ${t.state}`}))},we=()=>{we.wasFull&&!document.fullscreenElement&&ce(),!we.wasFull&&document.fullscreenElement,we.wasFull=!!document.fullscreenElement}})();